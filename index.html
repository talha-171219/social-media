<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Glassy Social - Complete Social Platform</title> 
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <meta name="description" content="Modern glass-style social media platform with real-time chat, posts, and profiles">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Day.js for date formatting -->
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/relativeTime.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1DB954',
                        secondary: '#1877F2'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Page look --- */
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            justify-content: center;
        }

        .btn:hover { transform: translateY(-1px); }

        .btn-primary { background: linear-gradient(135deg, #1DB954, #17a74a); color: #000; }
        .btn-secondary { background: linear-gradient(135deg, #1877F2, #166fe5); color: #fff; }
        .btn-ghost { background: rgba(255, 255, 255, 0.04); color: #f8fafc; border: 1px solid rgba(255, 255, 255, 0.06); }
        .btn-ghost:hover { background: rgba(255, 255, 255, 0.08); }

        .input, .textarea {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 0.6rem 0.9rem;
            color: #f8fafc;
            width: 100%;
        }

        .input:focus, .textarea:focus {
            outline: none;
            border-color: #1DB954;
            box-shadow: 0 0 0 4px rgba(29, 185, 84, 0.08);
        }

        .textarea { resize: none; min-height: 80px; }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #1DB954;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }

        .message {
            max-width: 70%;
            padding: 0.6rem 0.9rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }

        .message.own {
            background: linear-gradient(135deg, #1DB954, #17a74a);
            color: #000;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }

        .message.other {
            background: rgba(255, 255, 255, 0.06);
            color: #f8fafc;
            margin-right: auto;
            border-bottom-left-radius: 6px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #1DB954;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.28s ease;
            max-width: 320px;
        }

        .notification.show { transform: translateX(0); }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #1DB954;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }

        .reaction-btn {
            padding: 0.35rem 0.6rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #f8fafc;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .reaction-btn:hover { background: rgba(255, 255, 255, 0.08); }
        .reaction-btn.active { background: rgba(29, 185, 84, 0.18); border-color: #1DB954; color: #1DB954; }

        @media (max-width: 768px) { .message { max-width: 85%; } }
    </style>
</head>
<body>
    <div id="notifications"></div>
    <div id="app"></div>

    <script type="module">
        // dayjs
        dayjs.extend(window.dayjs_plugin_relativeTime);

        // Firebase v10 modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore, collection, doc, setDoc, getDoc, addDoc, query, orderBy,
            limit, onSnapshot, serverTimestamp, updateDoc, deleteDoc, increment, getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // ---------- Firebase config (kept as provided) ----------
        const firebaseConfig = {
            apiKey: "AIzaSyAatiY08DpbdqK6pAE53OWkQOJZJYTZbdI",
            authDomain: "social-app-f4758.firebaseapp.com",
            projectId: "social-app-f4758",
            storageBucket: "social-app-f4758.appspot.com",
            messagingSenderId: "381586413963",
            appId: "1:381586413963:web:2cead65d0b849aa277378e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // ---------- Global state ----------
        const state = {
            user: null,
            currentRoute: 'feed',
            posts: [],
            chatMessages: [],
            userProfile: null,
            currentChatRoom: 'general',
            replyTo: null,
            isLoading: false,
            unsubscribers: [],
            showComments: {} // track expanded comments by post id
        };

        // ---------- Utilities ----------
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return 'now';
            // Firestore serverTimestamp object has .seconds sometimes
            if (timestamp.seconds) return dayjs.unix(timestamp.seconds).fromNow();
            try { return dayjs(timestamp).fromNow(); } catch (e) { return 'now'; }
        };

        const showNotification = (message) => {
            const notification = document.createElement('div');
            notification.className = 'notification glass';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="flex-1">${escapeHtml(message)}</div>
                    <button class="text-white hover:text-gray-300 text-xl">√ó</button>
                </div>
            `;
            notification.querySelector('button').addEventListener('click', () => notification.remove());
            document.getElementById('notifications').appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 50);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4500);
        };

        // ---------- Auth helpers ----------
        const createUserProfile = async (user) => {
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        uid: user.uid,
                        name: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                        email: user.email || null,
                        avatar: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=1DB954&color=000`,
                        bio: 'New to Glassy Social! üåü',
                        following: [],
                        followers: [],
                        postsCount: 0,
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp(),
                    });
                }
            } catch (error) {
                console.error('Error creating user profile:', error);
            }
        };

        // ---------- Global event handlers (exposed to window for inline onclick usage) ----------
        window.handleGoogleLogin = async () => {
            try {
                state.isLoading = true; render();
                const result = await signInWithPopup(auth, googleProvider);
                await createUserProfile(result.user);
                showNotification('Successfully signed in with Google! ‚úîÔ∏è');
            } catch (error) {
                console.error('Google login error:', error);
                showNotification('Failed to sign in with Google');
            } finally {
                state.isLoading = false; render();
            }
        };

        window.handleAuthSubmit = async (event) => {
            event.preventDefault();
            const isSignup = event.submitter && event.submitter.dataset && event.submitter.dataset.action === 'signup';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('displayName').value;

            try {
                state.isLoading = true; render();
                if (isSignup) {
                    const result = await createUserWithEmailAndPassword(auth, email, password);
                    if (displayName) await updateProfile(result.user, { displayName });
                    await createUserProfile(result.user);
                    showNotification('Account created successfully! ‚úîÔ∏è');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showNotification('Successfully signed in! ‚úîÔ∏è');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showNotification(error.message || 'Authentication failed');
            } finally {
                state.isLoading = false; render();
            }
        };

        window.handleLogout = async () => {
            try {
                state.unsubscribers.forEach(u => u && typeof u === 'function' && u());
                state.unsubscribers = [];
                await signOut(auth);
                state.user = null;
                state.posts = [];
                state.chatMessages = [];
                state.userProfile = null;
                state.currentRoute = 'feed';
                showNotification('Successfully signed out! üö™');
                render();
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Failed to sign out');
            }
        };

        window.handleCreatePost = async () => {
            const text = document.getElementById('postText')?.value || '';
            const fileInput = document.getElementById('postImage');
            const imageFile = fileInput && fileInput.files && fileInput.files[0];

            if (!state.user) { showNotification('Please sign in to create posts'); return; }
            if (!text.trim() && !imageFile) { showNotification('Please write something or select an image'); return; }

            try {
                state.isLoading = true; render();
                let imageUrl = '';

                if (imageFile) {
                    const path = `posts/${state.user.uid}/${Date.now()}_${imageFile.name}`;
                    const ref = storageRef(storage, path);
                    const snapshot = await uploadBytes(ref, imageFile);
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                await addDoc(collection(db, 'posts'), {
                    authorId: state.user.uid,
                    authorName: state.user.displayName || state.user.email?.split('@')[0] || 'User',
                    authorAvatar: state.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.user.displayName || 'User')}&background=1DB954&color=000`,
                    text: text.trim(),
                    imageUrl,
                    commentsCount: 0,
                    reactionsCount: 0,
                    createdAt: serverTimestamp(),
                });

                const userRef = doc(db, 'users', state.user.uid);
                await updateDoc(userRef, { postsCount: increment(1), lastActive: serverTimestamp() });

                showNotification('Post created successfully!');
                if (document.getElementById('postText')) document.getElementById('postText').value = '';
                if (fileInput) fileInput.value = '';
            } catch (error) {
                console.error('Error creating post:', error);
                showNotification('Failed to create post');
            } finally {
                state.isLoading = false; render();
            }
        };

        window.deletePost = async (postId) => {
            if (!state.user) return;
            if (!confirm('Are you sure you want to delete this post?')) return;
            try {
                await deleteDoc(doc(db, 'posts', postId));
                const userRef = doc(db, 'users', state.user.uid);
                await updateDoc(userRef, { postsCount: increment(-1) });
                showNotification('Post deleted successfully');
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('Failed to delete post');
            }
        };

        window.toggleLike = async (postId) => {
            if (!state.user) { showNotification('Please sign in to like posts'); return; }
            try {
                const reactionRef = doc(db, 'posts', postId, 'reactions', state.user.uid);
                const reactionSnap = await getDoc(reactionRef);
                const postRef = doc(db, 'posts', postId);

                if (reactionSnap.exists()) {
                    await deleteDoc(reactionRef);
                    await updateDoc(postRef, { reactionsCount: increment(-1) });
                } else {
                    await setDoc(reactionRef, {
                        type: 'like',
                        userId: state.user.uid,
                        createdAt: serverTimestamp(),
                    });
                    await updateDoc(postRef, { reactionsCount: increment(1) });
                }
            } catch (error) {
                console.error('Error toggling like:', error);
                showNotification('Failed to update like');
            }
        };

        window.toggleComments = (postId) => {
            state.showComments[postId] = !state.showComments[postId];
            render();
        };

        window.handleAddComment = async (postId) => {
            const input = document.getElementById(`comment-${postId}`);
            const content = input && input.value.trim();
            if (!state.user || !content) return;
            try {
                await addDoc(collection(db, 'posts', postId, 'comments'), {
                    authorId: state.user.uid,
                    authorName: state.user.displayName || 'User',
                    authorAvatar: state.user.photoURL || '',
                    content,
                    createdAt: serverTimestamp(),
                });
                await updateDoc(doc(db, 'posts', postId), { commentsCount: increment(1) });
                showNotification('Comment added!');
                if (input) input.value = '';
            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('Failed to add comment');
            }
        };

        window.handleCommentKeyPress = (event, postId) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                window.handleAddComment(postId);
            }
        };

        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const content = input && input.value.trim();
            if (!state.user || !content) return;
            try {
                await addDoc(collection(db, 'chats', state.currentChatRoom, 'messages'), {
                    senderId: state.user.uid,
                    senderName: state.user.displayName || 'User',
                    senderAvatar: state.user.photoURL || '',
                    content,
                    roomId: state.currentChatRoom,
                    replyTo: state.replyTo || null,
                    timestamp: serverTimestamp(),
                    readBy: { [state.user.uid]: true },
                });
                state.replyTo = null;
                if (input) input.value = '';
                render();
                setTimeout(() => {
                    const container = document.getElementById('messagesContainer');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message');
            }
        };

        window.setReplyTo = (messageId, content, senderName) => {
            state.replyTo = { id: messageId, content, senderName };
            render();
            const input = document.getElementById('messageInput');
            if (input) input.focus();
        };

        window.clearReply = () => {
            state.replyTo = null;
            render();
        };

        window.updateProfile = async () => {
            const name = document.getElementById('profileName')?.value;
            const bio = document.getElementById('profileBio')?.value;
            if (!state.user) return;
            try {
                const userRef = doc(db, 'users', state.user.uid);
                await updateDoc(userRef, { name, bio });
                state.userProfile = { ...state.userProfile, name, bio };
                showNotification('Profile updated successfully! ‚úîÔ∏è');
                render();
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile');
            }
        };

        window.navigate = (route) => {
            state.currentRoute = route;
            if (route === 'chat' && state.user) {
                setupChatListener();
            }
            if (route === 'profile' && state.user) {
                loadUserProfile();
            }
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // ---------- Realtime listeners ----------
        const setupPostsListener = () => {
            const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(50));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                state.posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentRoute === 'feed') render();
            }, (err) => console.error('posts listener error', err));
            state.unsubscribers.push(unsubscribe);
        };

        const setupChatListener = () => {
            // Clean previous chat listener (if any)
            state.unsubscribers = state.unsubscribers.filter(u => {
                try { u && typeof u === 'function' && u(); } catch(e) {}
                return false;
            });

            const q = query(collection(db, 'chats', state.currentChatRoom, 'messages'), orderBy('timestamp', 'asc'), limit(500));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentRoute === 'chat') {
                    render();
                    setTimeout(() => {
                        const container = document.getElementById('messagesContainer');
                        if (container) container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            }, (err) => console.error('chat listener error', err));
            state.unsubscribers.push(unsubscribe);
        };

        const loadUserProfile = async () => {
            if (!state.user) return;
            try {
                const userRef = doc(db, 'users', state.user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    state.userProfile = userSnap.data();
                    render();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        };

        // ---------- Render functions ----------
        const renderNavbar = () => {
            if (!state.user) return '';
            return `
                <nav class="glass p-4 mb-6 sticky top-0 z-50">
                    <div class="max-w-6xl mx-auto flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl bg-primary flex items-center justify-center text-black font-bold">GS</div>
                            <div>
                                <h1 class="text-xl font-bold">Glassy Social</h1>
                                <p class="text-sm text-gray-400">Complete Social Platform</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button onclick="navigate('feed')" class="btn ${state.currentRoute === 'feed' ? 'btn-primary' : 'btn-ghost'}">üì± Feed</button>
                            <button onclick="navigate('chat')" class="btn ${state.currentRoute === 'chat' ? 'btn-primary' : 'btn-ghost'}">üí¨ Chat</button>
                            <button onclick="navigate('profile')" class="btn ${state.currentRoute === 'profile' ? 'btn-primary' : 'btn-ghost'}">üë§ Profile</button>
                            <img src="${state.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.user.displayName || 'User')}&background=1DB954&color=000`}" class="avatar" />
                            <button onclick="handleLogout()" class="btn btn-ghost">üö™ Logout</button>
                        </div>
                    </div>
                </nav>
            `;
        };

        const renderLogin = () => `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="glass p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 rounded-xl bg-primary flex items-center justify-center text-black font-bold text-2xl mx-auto mb-4">GS</div>
                        <h2 class="text-2xl font-bold mb-2">Welcome to Glassy Social</h2>
                        <p class="text-gray-400">Connect, share, and chat with friends</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="handleGoogleLogin()" class="btn btn-secondary w-full">
                            ${state.isLoading ? '<span class="loader"></span>' : 'üöÄ'} Continue with Google
                        </button>
                        <div class="text-center text-gray-400">or</div>
                        <form onsubmit="handleAuthSubmit(event)" class="space-y-4">
                            <input id="displayName" type="text" placeholder="Display Name (for signup)" class="input" />
                            <input id="email" type="email" placeholder="Email" class="input" required />
                            <input id="password" type="password" placeholder="Password" class="input" required />
                            <div class="flex gap-2">
                                <button type="submit" data-action="login" class="btn btn-primary flex-1">Login</button>
                                <button type="submit" data-action="signup" class="btn btn-ghost flex-1" data-action="signup" data-action-type="signup" data-action="signup">Sign Up</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        const renderPostComposer = () => {
            if (!state.user) return '';
            return `
                <div class="glass p-6 mb-6 max-w-2xl mx-auto">
                    <div class="flex items-start space-x-4">
                        <img src="${state.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.user.displayName || 'User')}&background=1DB954&color=000`}" class="avatar" />
                        <div class="flex-1">
                            <textarea id="postText" placeholder="What's on your mind?" class="textarea mb-4"></textarea>
                            <div class="flex items-center justify-between">
                                <input id="postImage" type="file" accept="image/*" class="text-sm text-gray-400" />
                                <button onclick="handleCreatePost()" class="btn btn-primary">
                                    ${state.isLoading ? '<span class="loader"></span>' : 'üìù'} Post
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPost = (post) => {
            // Ensure safe values
            const authorName = escapeHtml(post.authorName || 'User');
            const text = escapeHtml(post.text || '');
            const authorAvatar = post.authorAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(post.authorName || 'User')}&background=1DB954&color=000`;
            const imageHtml = post.imageUrl ? `<img src="${post.imageUrl}" class="mt-3 rounded-lg max-w-full h-auto" />` : '';
            const isOwner = post.authorId === state.user?.uid;

            return `
                <div class="glass p-6 mb-6 max-w-2xl mx-auto">
                    <div class="flex items-start space-x-4">
                        <img src="${authorAvatar}" class="avatar" />
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="font-semibold text-white">${authorName}</h3>
                                    <p class="text-sm text-gray-400">${formatTime(post.createdAt)}</p>
                                </div>
                                ${isOwner ? `<button onclick="deletePost('${post.id}')" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>` : `<button class="text-yellow-400 hover:text-yellow-300">‚ö†Ô∏è</button>`}
                            </div>
                            <div class="mb-4">
                                <p class="text-white whitespace-pre-wrap">${text}</p>
                                ${imageHtml}
                            </div>
                            <div class="flex items-center space-x-4 pt-4 border-t border-white/10">
                                <button onclick="toggleLike('${post.id}')" class="reaction-btn">‚ù§Ô∏è <span>${post.reactionsCount || 0}</span></button>
                                <button onclick="toggleComments('${post.id}')" class="reaction-btn">üí¨ <span>${post.commentsCount || 0}</span></button>
                            </div>
                            ${state.showComments[post.id] ? `
                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <div class="flex items-center space-x-3">
                                        <img src="${state.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.user.displayName || 'User')}&background=1DB954&color=000`}" class="w-8 h-8 rounded-full" />
                                        <input id="comment-${post.id}" placeholder="Write a comment..." class="input flex-1" onkeypress="handleCommentKeyPress(event, '${post.id}')" />
                                        <button onclick="handleAddComment('${post.id}')" class="btn btn-ghost">üí¨</button>
                                    </div>
                                    <div id="comments-list-${post.id}" class="mt-3 space-y-2"></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderFeed = () => `
            <div>
                ${renderPostComposer()}
                <div class="space-y-6">
                    ${state.posts.length ? state.posts.map(renderPost).join('') : `
                        <div class="glass p-8 text-center max-w-2xl mx-auto">
                            <h3 class="text-xl font-semibold mb-2">Welcome to Glassy Social!</h3>
                            <p class="text-gray-400">No posts yet. Be the first to share something amazing! üéâ</p>
                        </div>
                    `}
                </div>
            </div>
        `;

        const renderChat = () => {
            if (!state.user) {
                return `<div class="max-w-2xl mx-auto glass p-6 text-center"><h3 class="text-lg font-semibold text-white">Please login to use chat</h3></div>`;
            }

            const messagesHtml = state.chatMessages.map(msg => {
                const isOwn = msg.senderId === state.user.uid;
                const replyMarkup = msg.replyTo ? `<div class="text-xs text-gray-300 mb-1 pl-2 border-l border-gray-600">‚Ü™ <strong>${escapeHtml(msg.replyTo.senderName || 'User')}</strong>: ${escapeHtml(msg.replyTo.content || '')}</div>` : '';
                return `
                    <div class="w-full flex ${isOwn ? 'justify-end' : 'justify-start'}">
                        <div class="message ${isOwn ? 'own' : 'other'}">
                            ${replyMarkup}
                            <div class="flex items-center gap-2 mb-1">
                                <img src="${msg.senderAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.senderName || 'User')}&background=1DB954&color=000`}" class="w-6 h-6 rounded-full" />
                                <div class="text-xs text-gray-300">${escapeHtml(msg.senderName || 'User')}</div>
                                <div class="text-xs text-gray-500 ml-2">${formatTime(msg.timestamp)}</div>
                            </div>
                            <div class="text-sm">${escapeHtml(msg.content)}</div>
                            <div class="mt-2 text-right">
                                ${!isOwn ? `<button onclick="setReplyTo('${msg.id}', ${JSON.stringify(msg.content)}, ${JSON.stringify(msg.senderName)})" class="text-xs text-gray-300">Reply</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="max-w-4xl mx-auto">
                    <div class="glass p-4 mb-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold">Chat ‚Äî Room: ${escapeHtml(state.currentChatRoom)}</h3>
                            <p class="text-sm text-gray-400">Real-time messages</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="navigate('feed')" class="btn btn-ghost">‚Üê Back to Feed</button>
                        </div>
                    </div>

                    <div id="messagesContainer" class="glass p-4 mb-4 max-h-[60vh] overflow-y-auto" style="max-width:960px;margin:0 auto;">
                        ${messagesHtml || '<div class="text-gray-400 text-center py-6">No messages yet. Start the conversation!</div>'}
                    </div>

                    <div class="glass p-4 max-w-4xl mx-auto">
                        ${state.replyTo ? `<div class="mb-3 p-3 bg-white/5 rounded-md flex items-center justify-between"><div>Replying to <strong>${escapeHtml(state.replyTo.senderName)}</strong>: ${escapeHtml(state.replyTo.content)}</div><button onclick="clearReply()" class="btn btn-ghost">Clear</button></div>` : ''}
                        <div class="flex gap-2">
                            <input id="messageInput" class="input flex-1" placeholder="Write a message..." onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendMessage(); }" />
                            <button onclick="sendMessage()" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderProfile = () => {
            if (!state.user) {
                return `<div class="max-w-2xl mx-auto glass p-6 text-center"><h3 class="text-lg font-semibold text-white">Please login to view your profile</h3></div>`;
            }
            const profile = state.userProfile || {};
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="glass p-6 mb-6 flex items-center gap-4">
                        <img src="${profile.avatar || state.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.name || state.user.displayName || 'User')}&background=1DB954&color=000`}" class="w-20 h-20 rounded-full" />
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold">${escapeHtml(profile.name || state.user.displayName || 'User')}</h2>
                            <p class="text-gray-400">${escapeHtml(profile.bio || 'No bio yet')}</p>
                            <p class="text-sm text-gray-400 mt-2">Joined: ${profile.createdAt ? formatTime(profile.createdAt) : 'Unknown'}</p>
                        </div>
                    </div>

                    <div class="glass p-6 mb-6">
                        <h3 class="font-semibold mb-3">Edit Profile</h3>
                        <div class="space-y-3">
                            <input id="profileName" class="input" placeholder="Display name" value="${escapeHtml(profile.name || state.user.displayName || '')}" />
                            <textarea id="profileBio" class="textarea" placeholder="Short bio">${escapeHtml(profile.bio || '')}</textarea>
                            <div class="flex gap-2">
                                <button onclick="updateProfile()" class="btn btn-primary">Save</button>
                                <button onclick="navigate('feed')" class="btn btn-ghost">Back</button>
                            </div>
                        </div>
                    </div>

                    <div class="glass p-6">
                        <h3 class="font-semibold mb-3">Your Posts</h3>
                        <div class="space-y-4">
                            ${state.posts.filter(p => p.authorId === state.user.uid).map(p => `
                                <div class="p-4 border border-white/6 rounded-md">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="text-sm text-gray-300">${formatTime(p.createdAt)}</div>
                                        <button onclick="deletePost('${p.id}')" class="text-red-400">Delete</button>
                                    </div>
                                    <div class="text-white">${escapeHtml(p.text)}</div>
                                    ${p.imageUrl ? `<img src="${p.imageUrl}" class="mt-2 rounded-md max-w-full" />` : ''}
                                </div>
                            `).join('') || `<div class="text-gray-400">No posts yet.</div>`}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            const header = renderNavbar();
            let content = '';
            if (!state.user) {
                content = renderLogin();
            } else {
                if (state.currentRoute === 'feed') content = renderFeed();
                if (state.currentRoute === 'chat') content = renderChat();
                if (state.currentRoute === 'profile') content = renderProfile();
            }
            return `${header}<main class="pb-16">${content}</main>`;
        };

        // Helper: populate comments lists after feed is rendered
        const loadCommentsForVisiblePosts = async () => {
            // For each post currently expanded, fetch recent comments
            for (const postId of Object.keys(state.showComments)) {
                if (!state.showComments[postId]) continue;
                const container = document.getElementById(`comments-list-${postId}`);
                if (!container) continue;
                container.innerHTML = `<div class="text-gray-400 text-sm">Loading comments...</div>`;
                try {
                    const q = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'asc'), limit(50));
                    const snap = await getDocs(q);
                    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    container.innerHTML = items.map(c => `
                        <div class="flex items-start gap-3">
                            <img src="${c.authorAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.authorName || 'User')}&background=1DB954&color=000`}" class="w-8 h-8 rounded-full" />
                            <div>
                                <div class="text-sm"><strong>${escapeHtml(c.authorName || 'User')}</strong> <span class="text-xs text-gray-400">${formatTime(c.createdAt)}</span></div>
                                <div class="text-sm text-gray-200">${escapeHtml(c.content)}</div>
                            </div>
                        </div>
                    `).join('') || `<div class="text-gray-400 text-sm">No comments yet.</div>`;
                } catch (e) {
                    container.innerHTML = `<div class="text-red-400 text-sm">Failed to load comments</div>`;
                }
            }
        };

        // Main render wrapper
        const render = () => {
            document.getElementById('app').innerHTML = renderApp();
            // After DOM inserted, load comments for expanded posts
            loadCommentsForVisiblePosts();
        };

        // ---------- Initialisation ----------
        const init = async () => {
            // Setup posts listener always
            setupPostsListener();

            // Auth state listener
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    await createUserProfile(user);
                    loadUserProfile();
                    // setup chat listener if in chat
                    if (state.currentRoute === 'chat') setupChatListener();
                } else {
                    // remove unsubscribers
                    state.unsubscribers.forEach(u => { try { u && typeof u === 'function' && u(); } catch(e) {} });
                    state.unsubscribers = [];
                }
                render();
            });

            // initial render
            render();
        };

        init();

        // Expose state for debugging in dev console (optional)
        window.__GS_STATE = state;
    </script>
</body>
</html>
