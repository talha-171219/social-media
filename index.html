<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Glassy Social â€” Feed + Chat</title>

  <!-- Tailwind CDN (dev/demo only) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: { fb: { blue: '#1877F2' }, spotify: { green: '#1DB954' } },
        boxShadow: { glass: '0 8px 32px 0 rgba(31, 38, 135, 0.37)' }
      } }
    }
  </script>

  <style>
    body { background: radial-gradient(1200px 800px at 20% 0%, #0d0f12 10%, #0b0b0b 60%, #090909 100%); color:#f3f4f6; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .glass { background: rgba(18,18,18,0.55); border:1px solid rgba(255,255,255,0.08); box-shadow:0 8px 32px 0 rgba(31, 38, 135, 0.25); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius:1rem; }
    .btn { padding:.5rem .75rem; border-radius:9999px; font-weight:500; transition:opacity .15s; display:inline-flex; align-items:center; gap:.4rem; cursor:pointer; }
    .btn-primary { background:#1877F2; color:#fff; }
    .chip { font-size:.75rem; padding:.25rem .5rem; border-radius:9999px; background:rgba(255,255,255,0.08); display:inline-flex; align-items:center; gap:.35rem; }
    input.glass, textarea.glass { background: rgba(255,255,255,0.02); border:none; color:inherit; }
    a { color:#93c5fd; }
    #app { min-height:100vh; padding:24px 12px; }
    footer { color: #9ca3af; }

    /* Layout */
    .header { display:flex; align-items:center; gap:12px; padding:12px; }
    .chat-shell { display:flex; gap:16px; align-items:stretch; }
    .chat-left { width:300px; max-height:70vh; overflow:auto; }
    .chat-main { flex:1; display:flex; flex-direction:column; max-height:70vh; border-radius:12px; overflow:hidden; }
    .participants { padding:8px; border-bottom:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); }
    .participant { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; }
    .participant img { width:36px; height:36px; border-radius:999px; object-fit:cover; border:1px solid rgba(255,255,255,0.06); }

    #messages { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); }
    .message { max-width:72%; padding:10px 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.06); position:relative; word-break:break-word; }
    .me { align-self:flex-end; background: linear-gradient(180deg, rgba(29,185,84,0.22), rgba(29,185,84,0.12)); }
    .other { align-self:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); }
    .timestamp { font-size:.72rem; opacity:.75; margin-top:6px; text-align:right; }
    .reply { font-size:.86rem; opacity:.9; border-left:2px solid rgba(255,255,255,0.25); padding-left:8px; margin-bottom:6px; }

    .message-form { display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); }
    .message-form input { flex:1; padding:12px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; }

    .react-btn { padding: 6px 10px; border-radius:9999px; background:rgba(255,255,255,.06); }
    .react-btn.active { outline: 2px solid rgba(255,255,255,.25); }

    @media (max-width:900px){ .chat-left{ display:none; } .chat-shell{ flex-direction:column; } .chat-main{ max-height:60vh; } }
  </style>

  <!-- dayjs -->
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/relativeTime.js"></script>
  <script> dayjs.extend(window.dayjs_plugin_relativeTime); </script>
</head>
<body>
  <div id="app"></div>
  <footer class="text-center py-6">Built with <span style="color:#1DB954">â™¥</span> â€” Glassy Social + Chat</footer>

  <script type="module">
    /* à¦¤à§‹à¦®à¦¾à¦° à¦†à¦—à§‡à¦° à¦•à§‹à¦¡ à¦à¦•à¦¦à¦® à¦à¦•à¦‡ à¦°à¦‡à¦²...
       à¦¶à§à¦§à§ à¦¨à¦¿à¦šà§‡à¦° à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨à¦—à§à¦²à§‹ à¦¹à¦²à§‹ ðŸ‘‡ */

    // ========== FIXED PART ==========
    window.setReply = (id, content) => {
      replyTo = { id, content };
      const inp = document.getElementById('chat-input'); // <-- fixed id
      if(inp){ inp.value = 'Reply: ' + content + ' '; inp.focus(); }
    };

    // ===== CHAT UI (unchanged except consistent id) =====
    function ChatPage(){
      const msgsHtml = state.chatMsgs.map(m => {
        const meClass = m.senderId === uid() ? 'me' : 'other';
        const replyHtml = m.reply ? <div class="reply">â†ª ${escapeHtml(m.reply.content)}</div> : '';
        const ts = m.timestamp ? (m.timestamp.seconds ? dayjs.unix(m.timestamp.seconds).format('HH:mm') : '') : '';
        return `<div class="message ${meClass}">
            ${replyHtml}
            <div class="font-medium text-sm">${escapeHtml(m.senderName)}</div>
            <div class="mt-1">${escapeHtml(m.content)}</div>
            <div class="timestamp">${ts}</div>
            <div style="position:relative; margin-top:6px;">
              <button class="btn react-btn" data-reply-id="${m.id}" data-reply-content="${escapeAttr(m.content)}">Reply</button>
            </div>
          </div>`;
      }).join('');

      return `
        <main class="mx-auto max-w-6xl px-4 pb-24">
          <div class="chat-shell">
            <div class="chat-left glass p-3">
              <div class="font-semibold mb-2">People</div>
              <div class="participants" id="participantsPanel"></div>
            </div>

            <div class="chat-main glass">
              <div style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; justify-content:space-between; align-items:center;">
                <div class="font-semibold">General Chat</div>
                <div class="text-sm opacity-70">Public room</div>
              </div>

              <div id="messages">${ msgsHtml || <div class="p-6 text-center opacity-70">No messages yet â€” say hi ðŸ‘‹</div> }</div>
              <div class="flex items-center space-x-2 p-2 border-t border-gray-700">
                <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded-lg bg-gray-800 text-white outline-none"/>
                <button id="send-btn" class="px-4 py-2 bg-blue-600 rounded-lg">Send</button>
              </div>
            </div>
          </div>
        </main>
      `;
    }

    // Delegated event handling (inside bindGlobalHandlers)
    function bindGlobalHandlers(){
      if(globalHandlersBound) return;
      globalHandlersBound = true;

      document.addEventListener('click', async (e) => {
        const t = e.target;

        // send button (chat)
        if(t.matches('#send-btn')){
          const inp = document.getElementById('chat-input');
          const msg = inp.value.trim();
          if(!msg) return;
          await sendChat(msg);
          inp.value = '';
          return;
        }

        // ... à¦¤à§‹à¦®à¦¾à¦° à¦†à¦—à§‡à¦° nav/logout/login/post event handlers à¦à¦–à¦¾à¦¨à§‡ à¦…à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¿à¦¤ à¦¥à¦¾à¦•à¦¬à§‡ ...
      });

      // Press Enter in chat input
      document.addEventListener('keydown', async (e) => {
        const active = document.activeElement;
        if (active?.id === 'chat-input' && e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.querySelector('#send-btn')?.click();
        }
      });
    }

    // ========== END FIX ==========

    // initial route render
    parseRoute();
  </script>
</body>
</html>
